{
  "name": "RideAnalyticsAgent",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "47240e7d-5c44-465a-87e5-41e2588b07e3",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -672,
        304
      ],
      "webhookId": "35e804cc-01e6-4865-be54-d1c4d769e07f",
      "credentials": {
        "telegramApi": {
          "id": "hrSf1qoDARdmVL0r",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "159f9e02-2c9d-4589-8b75-75ba494fa36b"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "notStartsWith"
                    },
                    "id": "f957829d-7417-4327-97eb-3102d32add35"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "b73eaa3c-5730-4024-b201-ae011e4f23db",
      "name": "Check Message Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -448,
        304
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "ğŸš— Welcome to Ride Analytics!\n\nAvailable commands:\n\n/driver DRV000001 - Get driver details by ID\n/daily 2025-01-15 - Get daily ride metrics\n/revenue 2025-01-01 2025-01-31 - Revenue summary for date range\n\nExample: /driver DRV000001",
        "additionalFields": {}
      },
      "id": "e3dac7f5-e623-42f8-a437-747e7741dd56",
      "name": "Send Welcome Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -224,
        400
      ],
      "webhookId": "0369df36-85a8-4b2f-80aa-1c55b1076ade",
      "credentials": {
        "telegramApi": {
          "id": "hrSf1qoDARdmVL0r",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/driver",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "bb0b16d3-2b51-49a3-bee2-376078ac5346"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Driver Performance Details"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/revenue",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "a837bdc7-cac8-493a-b985-2a0ecf49df28"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Revenue Summary"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/daily",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "1d68599f-ed8e-4528-91d3-7fb52ac2b59a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Daily Rides"
            }
          ]
        },
        "options": {}
      },
      "id": "552984aa-05f8-4db6-b02c-eb23c0371323",
      "name": "Route Based on Option",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -224,
        176
      ]
    },
    {
      "parameters": {
        "url": "=https://ride-analytics-api-784230287441.us-central1.run.app/api/drivers/{{ $json.message.text.split(' ')[1] }}",
        "options": {}
      },
      "id": "bed36bbb-dd5a-4f42-94be-20ca5e541697",
      "name": "Get Driver Details API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "url": "https://ride-analytics-api-784230287441.us-central1.run.app/api/revenue/summary",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "start_date",
              "value": "={{ $json.message.text.split(' ')[1] }}"
            },
            {
              "name": "end_date",
              "value": "={{ $json.message.text.split(' ')[2] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "9803ca25-aed1-4346-b8b5-8453b98963d0",
      "name": "Get Revenue Summary API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        192
      ]
    },
    {
      "parameters": {
        "url": "https://ride-analytics-api-784230287441.us-central1.run.app/api/rides/daily/",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "date",
              "value": "={{ $json.message.text.split(' ')[1]  }}"
            }
          ]
        },
        "options": {}
      },
      "id": "903e66a9-0fef-4f9e-9a80-5df088702a1c",
      "name": "Get Daily Rides API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        384
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get the API response data\nconst apiResponse = $input.first().json;\n\n// Get chat ID from the Telegram Trigger\nconst chatId = $('Telegram Trigger').first().json.message.chat.id;\n\n// Format driver details into readable text\nlet message = \"ğŸš— *Driver Details*\\n\\n\";\n\nif (apiResponse && apiResponse.driver_id) {\n  const driverInfo = apiResponse.driver_info || {};\n  const performance = apiResponse.performance || {};\n  \n  message += `ğŸ†” *Driver ID:* ${apiResponse.driver_id}\\n\\n`;\n  \n  message += `ğŸ‘¤ *Driver Information*\\n`;\n  message += `â€¢ Name: ${driverInfo.name || 'N/A'}\\n`;\n  message += `â€¢ Email: ${driverInfo.email || 'N/A'}\\n`;\n  message += `â€¢ Vehicle Type: ${driverInfo.vehicle_type || 'N/A'}\\n`;\n  message += `â€¢ City: ${driverInfo.city || 'N/A'}\\n`;\n  message += `â€¢ Rating: ${driverInfo.rating || 'N/A'}\\n`;\n  message += `â€¢ Status: ${driverInfo.is_active ? 'Active âœ…' : 'Inactive âŒ'}\\n\\n`;\n  \n  message += `ğŸ“Š *Performance Metrics*\\n`;\n  message += `â€¢ Total Trips: ${performance.total_trips || 0}\\n`;\n  message += `â€¢ Total Earnings: $${performance.total_earnings || 0}\\n`;\n  message += `â€¢ Total Tips: $${performance.total_tips || 0}\\n`;\n  message += `â€¢ Average Rating: ${performance.avg_rating || 'N/A'}\\n`;\n  message += `â€¢ Avg Trip Duration: ${performance.avg_trip_duration_minutes || 0} minutes\\n`;\n  message += `â€¢ Avg Trip Distance: ${performance.avg_trip_distance_km || 0} km\\n`;\n  message += `â€¢ Completion Rate: ${performance.completion_rate || 0}%\\n`;\n} else {\n  message += \"âŒ Unable to fetch driver details. Please try again later.\";\n}\n\n// Return formatted message with chat ID\nreturn [{\n  json: {\n    chatId: chatId,\n    message: message\n  }\n}];"
      },
      "id": "d54d7984-6d2b-4f41-91ce-a55ae7b6909e",
      "name": "Format Driver Details",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get the API response data\nconst apiResponse = $input.first().json;\n\n// Get chat ID from the Telegram Trigger\nconst chatId = $('Telegram Trigger').first().json.message.chat.id;\n\n// Format revenue summary message\nlet message = \"ğŸ“Š *Revenue Summary*\\n\\n\";\n\nif (apiResponse && apiResponse.summary) {\n  const summary = apiResponse.summary;\n  \n  // Add date range if available\n  if (apiResponse.start_date && apiResponse.end_date) {\n    message += `ğŸ“… *Period:* ${apiResponse.start_date} to ${apiResponse.end_date}\\n\\n`;\n  }\n  \n  // Add summary statistics\n  message += `ğŸš— *Total Rides:* ${summary.total_rides || 0}\\n`;\n  message += `ğŸ’° *Total Revenue:* $${(summary.total_revenue || 0).toFixed(2)}\\n`;\n  message += `ğŸ’µ *Total Tips:* $${(summary.total_tips || 0).toFixed(2)}\\n`;\n  message += `ğŸ“ˆ *Average Fare:* $${(summary.avg_fare || 0).toFixed(2)}\\n`;\n  message += `ğŸ’¸ *Total Fare (with Tips):* $${(summary.total_fare_with_tips || 0).toFixed(2)}\\n`;\n  \n  // Add daily breakdown if available\n  if (apiResponse.daily_breakdown && Array.isArray(apiResponse.daily_breakdown) && apiResponse.daily_breakdown.length > 0) {\n    message += `\\nğŸ“Š *Daily Breakdown:*\\n\\n`;\n    \n    apiResponse.daily_breakdown.forEach(day => {\n      message += `ğŸ“… ${day.date}\\n`;\n      message += `  ğŸš— Rides: ${day.rides || 0}\\n`;\n      message += `  ğŸ’° Revenue: $${(day.revenue || 0).toFixed(2)}\\n`;\n      message += `\\n`;\n    });\n  }\n} else {\n  message += \"âŒ Unable to fetch revenue summary. Please try again later.\";\n}\n\n// Return formatted message with chat ID\nreturn [\n  {\n    json: {\n      chatId: chatId,\n      message: message\n    }\n  }\n];"
      },
      "id": "343c8b4e-9d75-462b-9207-77a2b139e6c4",
      "name": "Format Revenue Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        192
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get the API response data\nconst apiResponse = $input.first().json;\n\n// Get chat ID from the Telegram Trigger\nconst chatId = $('Telegram Trigger').first().json.message.chat.id;\n\n// Format the daily rides message\nlet message = \"ğŸ“Š *Daily Rides Summary*\\n\\n\";\n\nif (apiResponse && apiResponse.date && apiResponse.data) {\n  const data = apiResponse.data;\n  \n  message += `ğŸ“… *Date:* ${apiResponse.date}\\n\\n`;\n  message += `ğŸš— *Total Rides:* ${data.total_rides || 0}\\n`;\n  message += `ğŸ’° *Total Revenue:* $${(data.total_revenue || 0).toFixed(2)}\\n`;\n  message += `ğŸ’µ *Total Tips:* $${(data.total_tips || 0).toFixed(2)}\\n`;\n  message += `ğŸ’¸ *Total Fare (with Tips):* $${(data.total_fare_with_tips || 0).toFixed(2)}\\n`;\n  message += `â±ï¸ *Avg Duration:* ${(data.avg_duration_minutes || 0).toFixed(1)} minutes\\n`;\n  message += `ğŸ“ *Avg Distance:* ${(data.avg_distance_km || 0).toFixed(2)} km\\n`;\n  message += `ğŸ“ˆ *Avg Fare:* $${(data.avg_fare || 0).toFixed(2)}\\n`;\n} else {\n  message += \"âŒ No daily rides data available.\";\n}\n\n// Return formatted data\nreturn [{\n  json: {\n    chatId: chatId,\n    message: message\n  }\n}];"
      },
      "id": "5979bf28-39eb-4980-86a5-c2e3ff8bf077",
      "name": "Format Daily Rides",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        384
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {}
      },
      "id": "3d9d504d-52dc-41b1-be8c-a63570e74cea",
      "name": "Send Response to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        448,
        112
      ],
      "webhookId": "f77828d8-0b0f-465b-b405-1a4a088e3d75",
      "credentials": {
        "telegramApi": {
          "id": "hrSf1qoDARdmVL0r",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Check Message Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Message Type": {
      "main": [
        [
          {
            "node": "Send Welcome Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Route Based on Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Based on Option": {
      "main": [
        [
          {
            "node": "Get Driver Details API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Revenue Summary API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Daily Rides API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Driver Details API": {
      "main": [
        [
          {
            "node": "Format Driver Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Revenue Summary API": {
      "main": [
        [
          {
            "node": "Format Revenue Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Daily Rides API": {
      "main": [
        [
          {
            "node": "Format Daily Rides",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Driver Details": {
      "main": [
        [
          {
            "node": "Send Response to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Revenue Summary": {
      "main": [
        [
          {
            "node": "Send Response to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Daily Rides": {
      "main": [
        [
          {
            "node": "Send Response to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "957c6327-0f1f-47b1-9846-212c58c1bd18",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "febe94628448a6f0bfca3729447abfa3710ab84df30b34312dc3c5665436e0c8"
  },
  "id": "q7e7G4VDuspIOQvU",
  "tags": []
}